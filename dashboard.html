<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€“ Speak Louder, Love Harder</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Minimal inline styling for demo */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #fafafa; margin: 20px; }
    section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 0 8px #ccc; }
    h2 { color: var(--primary-color, #a64ac9); }
    button, input, textarea { font-size: 1rem; padding: 8px; margin-top: 6px; width: 100%; max-width: 400px; }
    ul { padding-left: 20px; }
    ul li { margin-bottom: 8px; }
    .inline-flex { display: flex; gap: 10px; flex-wrap: wrap; }
    .inline-flex > * { flex: 1; min-width: 120px; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    nav a { margin-right: 15px; text-decoration: none; color: var(--accent-color, #ff6f91); }
    nav { margin-bottom: 30px; }
  </style>
</head>
<body>
  <header>
    <h1>Welcome to Your Dashboard ðŸ’–</h1>
    <nav>
      <a href="settings.html">Edit Profile & Settings</a>
      <a href="logout.html">Logout</a>
    </nav>
  </header>

  <section id="profile-section">
    <h2>Your Profile</h2>
    <p><strong>Name:</strong> <span id="profile-name">Loading...</span></p>
    <p><strong>Bio:</strong> <span id="profile-bio">Loading...</span></p>
  </section>

  <section id="mood-tracker">
    <h2>Mood Tracker</h2>
    <form id="mood-form">
      <label for="mood-date">Date:</label>
      <input type="date" id="mood-date" required />
      
      <label for="mood-rating">Mood (1-10):</label>
      <input type="number" id="mood-rating" min="1" max="10" required />
      
      <button type="submit">Add Mood Entry</button>
    </form>
    <ul id="mood-list"><li>Loading mood entries...</li></ul>
  </section>

  <section id="saved-posts">
    <h2>Saved Posts</h2>
    <ul id="saved-posts-list"><li>Loading saved posts...</li></ul>
  </section>

  <section id="posted-stories">
    <h2>Your Posted Stories</h2>
    <ul id="posted-stories-list"><li>Loading your stories...</li></ul>
  </section>

  <section id="journal">
    <h2>Personal Journal</h2>
    <textarea id="journal-content" rows="6" placeholder="Write your journal here..."></textarea>
    <button id="save-journal-btn">Save Journal</button>
    <p id="journal-status" aria-live="polite"></p>
  </section>

  <section id="suggestions">
    <h2>Feel-Good Suggestions</h2>
    <ul>
      <li>Take a 10-minute walk outside and breathe deeply.</li>
      <li>Write down three things youâ€™re grateful for today.</li>
      <li>Listen to your favorite uplifting music.</li>
      <li>Try a short meditation or mindfulness exercise.</li>
      <li>Reach out to a friend or loved one for a quick chat.</li>
    </ul>
  </section>

  <section id="saved-worksheets">
    <h2>Saved Worksheets</h2>
    <ul id="saved-worksheets-list"><li>Loading worksheets...</li></ul>
  </section>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config (replace if needed)
    const firebaseConfig = {
      apiKey: "AIzaSyCzmBdZJrtHEoxcAHte2B8iMrea-ctSxy8",
      authDomain: "speak-louder-581d7.firebaseapp.com",
      projectId: "speak-louder-581d7",
      storageBucket: "speak-louder-581d7.firebasestorage.app",
      messagingSenderId: "674769404942",
      appId: "1:674769404942:web:1cbda7d50ff15208dce85f",
      measurementId: "G-54XJLK1CGJ"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI references
    const profileNameEl = document.getElementById('profile-name');
    const profileBioEl = document.getElementById('profile-bio');
    const moodListEl = document.getElementById('mood-list');
    const savedPostsListEl = document.getElementById('saved-posts-list');
    const postedStoriesListEl = document.getElementById('posted-stories-list');
    const journalContentEl = document.getElementById('journal-content');
    const journalStatusEl = document.getElementById('journal-status');
    const savedWorksheetsListEl = document.getElementById('saved-worksheets-list');

    // Helper: format date nicely
    function formatDate(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const uid = user.uid;

      // Load profile
      db.collection('profiles').doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            const data = doc.data();
            profileNameEl.textContent = data.name || "(No name set)";
            profileBioEl.textContent = data.bio || "(No bio set)";
          } else {
            profileNameEl.textContent = "(No profile found)";
            profileBioEl.textContent = "";
          }
        }).catch(e => {
          profileNameEl.textContent = "Error loading profile";
          profileBioEl.textContent = "";
          console.error("Profile load error", e);
        });

      // Load mood entries
      db.collection('moodEntries').doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            const entries = doc.data().entries || [];
            if (entries.length === 0) {
              moodListEl.innerHTML = "<li>No mood entries yet.</li>";
            } else {
              // Sort descending by date
              entries.sort((a,b) => new Date(b.date) - new Date(a.date));
              moodListEl.innerHTML = entries
                .map(e => `<li><strong>${formatDate(e.date)}:</strong> Mood rating ${e.mood}</li>`)
                .join('');
            }
          } else {
            moodListEl.innerHTML = "<li>No mood entries yet.</li>";
          }
        }).catch(e => {
          moodListEl.innerHTML = "<li>Error loading mood entries.</li>";
          console.error("Mood entries load error", e);
        });

      // Load saved posts
      db.collection('savedPosts').doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            const posts = doc.data().posts || [];
            savedPostsListEl.innerHTML = posts.length > 0
              ? posts.map(p => `<li>${p.title}</li>`).join('')
              : "<li>No saved posts.</li>";
          } else {
            savedPostsListEl.innerHTML = "<li>No saved posts.</li>";
          }
        }).catch(e => {
          savedPostsListEl.innerHTML = "<li>Error loading saved posts.</li>";
          console.error("Saved posts load error", e);
        });

      // Load posted stories
      db.collection('postedStories').doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            const stories = doc.data().stories || [];
            postedStoriesListEl.innerHTML = stories.length > 0
              ? stories.map(s => `<li>${s.title}</li>`).join('')
              : "<li>No stories posted yet.</li>";
          } else {
            postedStoriesListEl.innerHTML = "<li>No stories posted yet.</li>";
          }
        }).catch(e => {
          postedStoriesListEl.innerHTML = "<li>Error loading stories.</li>";
          console.error("Stories load error", e);
        });

      // Load journal
      db.collection('journals').doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            journalContentEl.value = doc.data().content || "";
          } else {
            journalContentEl.value = "";
          }
        }).catch(e => {
          journalContentEl.value = "";
          console.error("Journal load error", e);
        });

      // Load saved worksheets
      db.collection('savedWorksheets').doc(uid).get()
        .then(doc => {
          if (doc.exists) {
            const worksheets = doc.data().worksheets || [];
            savedWorksheetsListEl.innerHTML = worksheets.length > 0
              ? worksheets.map(w => `<li>${w.title}</li>`).join('')
              : "<li>No worksheets saved.</li>";
          } else {
            savedWorksheetsListEl.innerHTML = "<li>No worksheets saved.</li>";
          }
        }).catch(e => {
          savedWorksheetsListEl.innerHTML = "<li>Error loading worksheets.</li>";
          console.error("Worksheets load error", e);
        });
    });

    // Add mood entry form submit
    document.getElementById('mood-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in.");
        return;
      }

      const uid = user.uid;
      const date = document.getElementById('mood-date').value;
      const mood = parseInt(document.getElementById('mood-rating').value, 10);

      // Validate inputs more strictly
      if (!date) {
        alert("Please select a date.");
        return;
      }
      if (isNaN(mood) || mood < 1 || mood > 10) {
        alert("Please enter a valid mood rating between 1 and 10.");
        return;
      }

      try {
        const moodRef = db.collection('moodEntries').doc(uid);
        const doc = await moodRef.get();
        let entries = doc.exists ? doc.data().entries || [] : [];

        // Check if there's already an entry for that date to update
        const index = entries.findIndex(e => e.date === date);
        if (index !== -1) {
          entries[index].mood = mood; // update existing
        } else {
          entries.push({ date, mood }); // add new
        }

        await moodRef.set({ entries }, { merge: true });

        // Update UI
        entries.sort((a,b) => new Date(b.date) - new Date(a.date));
        moodListEl.innerHTML = entries
          .map(e => `<li><strong>${formatDate(e.date)}:</strong> Mood rating ${e.mood}</li>`)
          .join('');

        // Reset form
        e.target.reset();
      } catch (error) {
        alert("Error saving mood entry: " + error.message);
        console.error(error);
      }
    });

    // Save journal button
    document.getElementById('save-journal-btn').addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) {
        alert("You must be logged in.");
        return;
      }
      const uid = user.uid;
      const content = journalContentEl.value.trim();

      // Disable button while saving
      const btn = document.getElementById('save-journal-btn');
      btn.disabled = true;
      journalStatusEl.textContent = "Saving...";

      try {
        await db.collection('journals').doc(uid).set({ content });
        journalStatusEl.textContent = "Journal saved!";
        setTimeout(() => journalStatusEl.textContent = "", 3000);
      } catch (error) {
        journalStatusEl.textContent = "Error saving journal: " + error.message;
        console.error(error);
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>