<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Settings – Speak Louder, Love Harder</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #fafafa; }
    section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px #ccc; max-width: 450px; margin: auto; }
    h1, h2 { color: var(--primary-color, #a64ac9); }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input[type="text"], textarea { width: 100%; padding: 8px; margin-top: 6px; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc; }
    button { background-color: var(--accent-color, #ff6f91); color: white; border: none; padding: 10px 15px; margin-top: 15px; cursor: pointer; font-size: 1rem; border-radius: 4px; transition: background-color 0.3s ease; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    button:hover:not(:disabled) { background-color: #e85c7a; }
    #profile-pic-preview { display: block; width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-top: 15px; border: 2px solid var(--primary-color, #a64ac9); }
    #success-message { margin-top: 15px; color: green; font-weight: bold; }
    #error-message { margin-top: 15px; color: red; font-weight: bold; }
    nav { max-width: 450px; margin: 0 auto 20px auto; }
    nav a { margin-right: 20px; color: var(--accent-color, #ff6f91); text-decoration: none; font-weight: 600; }
  </style>
</head>
<body>
  <nav>
    <a href="dashboard.html">← Back to Dashboard</a>
    <a href="logout.html">Logout</a>
  </nav>

  <section>
    <h1>Profile Settings</h1>

    <label for="profile-pic">Profile Picture</label>
    <input type="file" id="profile-pic" accept="image/*" />
    <img id="profile-pic-preview" src="default-profile.png" alt="Profile Picture Preview" />

    <label for="name">Name</label>
    <input type="text" id="name" placeholder="Your name" />

    <label for="bio">Bio</label>
    <textarea id="bio" rows="4" placeholder="Tell us about yourself"></textarea>

    <button id="save-btn">Save Settings</button>
    <p id="success-message"></p>
    <p id="error-message"></p>
  </section>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCzmBdZJrtHEoxcAHte2B8iMrea-ctSxy8",
      authDomain: "speak-louder-581d7.firebaseapp.com",
      projectId: "speak-louder-581d7",
      storageBucket: "speak-louder-581d7.firebasestorage.app",
      messagingSenderId: "674769404942",
      appId: "1:674769404942:web:1cbda7d50ff15208dce85f",
      measurementId: "G-54XJLK1CGJ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const profilePicInput = document.getElementById('profile-pic');
    const profilePicPreview = document.getElementById('profile-pic-preview');
    const nameInput = document.getElementById('name');
    const bioInput = document.getElementById('bio');
    const saveBtn = document.getElementById('save-btn');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');

    let currentUser;
    let profilePicFile = null;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;

      try {
        const doc = await db.collection('profiles').doc(user.uid).get();
        if (doc.exists) {
          const data = doc.data();
          nameInput.value = data.name || '';
          bioInput.value = data.bio || '';
          if (data.photoURL && data.photoURL.startsWith('http')) {
            profilePicPreview.src = data.photoURL;
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        errorMessage.textContent = 'Failed to load profile data.';
      }
    });

    profilePicInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        profilePicFile = file;
        const reader = new FileReader();
        reader.onload = event => {
          profilePicPreview.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    saveBtn.addEventListener('click', async () => {
      if (!currentUser) return;

      saveBtn.disabled = true;
      successMessage.textContent = '';
      errorMessage.textContent = '';

      try {
        let photoURL = null;

        // Get existing photoURL to keep if no new pic uploaded
        const doc = await db.collection('profiles').doc(currentUser.uid).get();
        if (doc.exists) {
          photoURL = doc.data().photoURL || null;
        }

        // Upload new profile picture if selected
        if (profilePicFile) {
          const storageRef = storage.ref();
          // Fixed file path overwrites old pic, avoid duplicates
          const profilePicRef = storageRef.child(`profilePics/${currentUser.uid}/profile.jpg`);
          const snapshot = await profilePicRef.put(profilePicFile);
          photoURL = await snapshot.ref.getDownloadURL();
        }

        // Update Firebase Auth profile for consistent displayName and photoURL
        await currentUser.updateProfile({
          displayName: nameInput.value.trim(),
          photoURL: photoURL
        });

        // Save profile info to Firestore with merge
        await db.collection('profiles').doc(currentUser.uid).set({
          name: nameInput.value.trim(),
          bio: bioInput.value.trim(),
          photoURL: photoURL
        }, { merge: true });

        successMessage.textContent = 'Settings saved successfully!';
        profilePicInput.value = '';
        profilePicFile = null;
      } catch (error) {
        console.error('Error saving settings:', error);
        errorMessage.textContent = 'Error saving settings: ' + error.message;
      } finally {
        saveBtn.disabled = false;
      }
    });
  </script>
</body>
</html>